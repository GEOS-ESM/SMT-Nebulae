
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="https://geos-esm.github.io/SMT-Nebulae/technical/backend/dace-bridge/" rel="canonical"/>
<link href="../ADRs/stree_ndsl-integration/" rel="prev"/>
<link href="../../../GEOS/" rel="next"/>
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.22" name="generator"/>
<title>GT4Py/DaCe bridge via expansion - SMT Knowledge Base</title>
<link href="../../../assets/stylesheets/main.84d31ad4.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../../stylesheets/extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#gt4py-dace-bridge">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="SMT Knowledge Base" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="SMT Knowledge Base">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            SMT Knowledge Base
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              GT4Py/DaCe bridge via expansion
            
          </span>
</div>
</div>
</div>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<a aria-label="Share" class="md-search__icon md-icon" data-clipboard="" data-clipboard-text="" data-md-component="search-share" href="javascript:void(0)" tabindex="-1" title="Share">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg>
</a>
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="SMT Knowledge Base" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="SMT Knowledge Base">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    SMT Knowledge Base
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Project 2426
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Project 2426
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../project2426/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../project2426/milestone1/">
<span class="md-ellipsis">
    Milestone 1
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../project2426/milestone2/">
<span class="md-ellipsis">
    Milestone 2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../project2426/milestone3/">
<span class="md-ellipsis">
    Milestone 3
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../project2426/milestone4/">
<span class="md-ellipsis">
    Milestone 4
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
<span class="md-ellipsis">
    Results
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_6">
<span class="md-nav__icon md-icon"></span>
            Results
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../project2426/results/M2_Sept25/summary/">
<span class="md-ellipsis">
    Milestone 2
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../project2426/results/SC23/">
<span class="md-ellipsis">
    Supercomputing 23
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../project2426/results/science-targets/">
<span class="md-ellipsis">
    Science Targets
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../project2426/results/hpc-metrics/">
<span class="md-ellipsis">
    HPC Metrics
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    Technical
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Technical
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../laundry-list/">
<span class="md-ellipsis">
    The Laundry List 👕
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
<span class="md-ellipsis">
    Dev setup
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
            Dev setup
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../dev-setup/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../dev-setup/tech-stack/">
<span class="md-ellipsis">
    Tech stack
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../dev-setup/vscode/">
<span class="md-ellipsis">
    VSCode config
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
<span class="md-ellipsis">
    Frontend
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
            Frontend
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../frontend/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../frontend/ndsl_features/">
<span class="md-ellipsis">
    NDSL features
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../frontend/experimental_features/">
<span class="md-ellipsis">
    Experimental "physics" features
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_4_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4_4" id="__nav_3_4_4_label" tabindex="0">
<span class="md-ellipsis">
    ADRs
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_4_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_4_4">
<span class="md-nav__icon md-icon"></span>
            ADRs
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../frontend/ADRs/">
<span class="md-ellipsis">
    Index
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../frontend/ADRs/fields_bundle/">
<span class="md-ellipsis">
    Fields Bundle
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
<span class="md-ellipsis">
    Porting
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_5">
<span class="md-nav__icon md-icon"></span>
            Porting
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../porting/translate_test/">
<span class="md-ellipsis">
    Translate tests
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
<span class="md-ellipsis">
    Backend work
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_6">
<span class="md-nav__icon md-icon"></span>
            Backend work
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../schedule-tree/">
<span class="md-ellipsis">
    Schedule Tree bridge
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../coding-guidelines/">
<span class="md-ellipsis">
    Coding guidelines
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../orchestration/">
<span class="md-ellipsis">
    Orchestration
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_6_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_6_5" id="__nav_3_6_5_label" tabindex="0">
<span class="md-ellipsis">
    Repositories
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_6_5_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_6_5">
<span class="md-nav__icon md-icon"></span>
            Repositories
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../repositories/ndsl/">
<span class="md-ellipsis">
    NDSL
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../repositories/gt4py/">
<span class="md-ellipsis">
    GT4Py
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../repositories/dace/">
<span class="md-ellipsis">
    DaCe
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_6_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_6_6" id="__nav_3_6_6_label" tabindex="0">
<span class="md-ellipsis">
    ADRs
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_6_6_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_6_6">
<span class="md-nav__icon md-icon"></span>
            ADRs
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../ADRs/">
<span class="md-ellipsis">
    Index
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ADRs/stree/">
<span class="md-ellipsis">
    Schedule tree
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ADRs/stree_dace-version/">
<span class="md-ellipsis">
    Schedule tree (DaCe version)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ADRs/stree_ndsl-integration/">
<span class="md-ellipsis">
    Schedule tree (NDSL integration)
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_6_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_6_7" id="__nav_3_6_7_label" tabindex="0">
<span class="md-ellipsis">
    Archive
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_6_7_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_6_7">
<span class="md-nav__icon md-icon"></span>
            Archive
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    GT4Py/DaCe bridge via expansion
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    GT4Py/DaCe bridge via expansion
    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#building-the-bridge-a-two-step-process">
<span class="md-ellipsis">
      Building the bridge - a two step process
    </span>
</a>
<nav aria-label="Building the bridge - a two step process" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#building-the-coarse-grained-sdfg">
<span class="md-ellipsis">
      Building the coarse-grained SDFG
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#expanding-the-library-nodes">
<span class="md-ellipsis">
      Expanding the library nodes
    </span>
</a>
<nav aria-label="Expanding the library nodes" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#building-dace-ir-from-oir">
<span class="md-ellipsis">
      Building DaCe-IR from OIR
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#building-sdfg-from-dace-ir">
<span class="md-ellipsis">
      Building SDFG from DaCe-IR
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#code-generation-for-tasklets">
<span class="md-ellipsis">
      Code generation for Tasklets
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#orchestration">
<span class="md-ellipsis">
      Orchestration
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#future-work">
<span class="md-ellipsis">
      Future work
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    GEOS
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            GEOS
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../GEOS/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../GEOS/local_build/">
<span class="md-ellipsis">
    Local build
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../GEOS/discover_build/">
<span class="md-ellipsis">
    Discover
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../GEOS/gh200/">
<span class="md-ellipsis">
    PRISM (GH200)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../GEOS/validation_basics/">
<span class="md-ellipsis">
    Validation
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
<span class="md-ellipsis">
    Component documentation
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_6">
<span class="md-nav__icon md-icon"></span>
            Component documentation
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../GEOS/components/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_6_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_6_2" id="__nav_4_6_2_label" tabindex="0">
<span class="md-ellipsis">
    Dynamics
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_6_2_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_4_6_2">
<span class="md-nav__icon md-icon"></span>
            Dynamics
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../GEOS/components/dynamics/pyFV3/">
<span class="md-ellipsis">
    pyFV3
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_6_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_6_3" id="__nav_4_6_3_label" tabindex="0">
<span class="md-ellipsis">
    Moist
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_6_3_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_4_6_3">
<span class="md-nav__icon md-icon"></span>
            Moist
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../GEOS/components/moist/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../GEOS/components/moist/GF/">
<span class="md-ellipsis">
    GF
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../GEOS/components/moist/GFDL_1M/">
<span class="md-ellipsis">
    GFDL_1M
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../GEOS/components/moist/RAS/">
<span class="md-ellipsis">
    RAS
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../GEOS/components/moist/UW/">
<span class="md-ellipsis">
    UW
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_6_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_6_4" id="__nav_4_6_4_label" tabindex="0">
<span class="md-ellipsis">
    Chemistry
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_6_4_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_4_6_4">
<span class="md-nav__icon md-icon"></span>
            Chemistry
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../GEOS/components/chemistry/pchem/">
<span class="md-ellipsis">
    PChem
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-ellipsis">
    Tutorials
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tutorials/">
<span class="md-ellipsis">
    Start Here!
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
<span class="md-ellipsis">
    NDSL
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_2">
<span class="md-nav__icon md-icon"></span>
            NDSL
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tutorials/ndsl_user_manual/ndsl_introduction/">
<span class="md-ellipsis">
    1. Introduction to NDSL
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tutorials/ndsl_user_manual/data/">
<span class="md-ellipsis">
    2. Data Types and Storage
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tutorials/ndsl_user_manual/writing_ndsl_code/">
<span class="md-ellipsis">
    3. Writing Code with NDSL
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tutorials/ndsl_user_manual/advanced_features/">
<span class="md-ellipsis">
    4. Advanced Features
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tutorials/ndsl_user_manual/backends/">
<span class="md-ellipsis">
    5. Backends
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tutorials/ndsl_user_manual/common_patterns/">
<span class="md-ellipsis">
    6. Common Patterns
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tutorials/ndsl_user_manual/why_use_classes/">
<span class="md-ellipsis">
    7. Why Use Classes?
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tutorials/ndsl_user_manual/best_coding_practices/">
<span class="md-ellipsis">
    8. Best Coding Practices
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
<span class="md-ellipsis">
    GEOS
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_3">
<span class="md-nav__icon md-icon"></span>
            GEOS
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tutorials/geos_with_ndsl/">
<span class="md-ellipsis">
    Introduction to GEOS
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
<span class="md-ellipsis">
    Model Development with NDSL
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_4">
<span class="md-nav__icon md-icon"></span>
            Model Development with NDSL
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tutorials/developing_with_ndsl/">
<span class="md-ellipsis">
    Model Development with NDSL
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tutorials/faq/">
<span class="md-ellipsis">
    FAQ
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
<span class="md-ellipsis">
    The Code Nebula
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            The Code Nebula
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tcn/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tcn/packages/">
<span class="md-ellipsis">
    Packages
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tcn/results/">
<span class="md-ellipsis">
    Results
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
<span class="md-ellipsis">
    Satellite work
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_7_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
            Satellite work
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../satellite-work/pace/">
<span class="md-ellipsis">
    Pace
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#building-the-bridge-a-two-step-process">
<span class="md-ellipsis">
      Building the bridge - a two step process
    </span>
</a>
<nav aria-label="Building the bridge - a two step process" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#building-the-coarse-grained-sdfg">
<span class="md-ellipsis">
      Building the coarse-grained SDFG
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#expanding-the-library-nodes">
<span class="md-ellipsis">
      Expanding the library nodes
    </span>
</a>
<nav aria-label="Expanding the library nodes" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#building-dace-ir-from-oir">
<span class="md-ellipsis">
      Building DaCe-IR from OIR
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#building-sdfg-from-dace-ir">
<span class="md-ellipsis">
      Building SDFG from DaCe-IR
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#code-generation-for-tasklets">
<span class="md-ellipsis">
      Code generation for Tasklets
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#orchestration">
<span class="md-ellipsis">
      Orchestration
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#future-work">
<span class="md-ellipsis">
      Future work
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="gt4py-dace-bridge"><abbr title="GridTools for Python">GT4Py</abbr> / <abbr title="Data-Centric Parallel Programming">DaCe</abbr> bridge</h1>
<p>"The bridge" commonly refers to the <abbr title="Data-Centric Parallel Programming">DaCe</abbr> backends of <abbr title="GridTools for Python">GT4Py</abbr>. The backends translate <abbr title="GridTools for Python">GT4Py</abbr> stencils into SDFGs, which allows <abbr title="Data-Centric Parallel Programming">DaCe</abbr> to do its magic on them. Since stencil-level optimization isn't enough for application performance, <abbr title="NOAA/NASA Domain Specific Language middleware">NDSL</abbr> supercharges the <abbr title="Data-Centric Parallel Programming">DaCe</abbr> backends by transforming all code to SDFGs. We call this orchestration.</p>
<h2 id="building-the-bridge-a-two-step-process">Building the bridge - a two step process</h2>
<p>Roughly, the dace backends are built in two steps:</p>
<ol>
<li>For each stencil, we build a "coarse-grained <abbr title="Stateful Dataflow multiGraphs (DaCe concept)">SDFG</abbr>" with a library node for every <code>VerticalLoop</code></li>
<li>We then "expand" each library node, replacing it with a nested <abbr title="Stateful Dataflow multiGraphs (DaCe concept)">SDFG</abbr></li>
</ol>
<h3 id="building-the-coarse-grained-sdfg">Building the coarse-grained <abbr title="Stateful Dataflow multiGraphs (DaCe concept)">SDFG</abbr></h3>
<p>Building the coarse-grained <abbr title="Stateful Dataflow multiGraphs (DaCe concept)">SDFG</abbr> happens in the <code>OirSDFGBuilder</code><sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> and is cached as <code>unexpanded_sdfg</code> in the <code>SDFGManager</code><sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup> after "pre-expand transformations" (e.g. setting loop expansion order and tile sizes) are applied.</p>
<details class="note">
<summary>Refactor opportunity: Transient read after write</summary>
<p><code>OirSDFGBuilder</code> follows a simple algorithm that connects an incoming Memlet for every read access and an outgoing Memlet for every write access to the library node. For transient memory that is only read after written (within that library node), this results in an unused incoming Memlet. <abbr title="Data-Centric Parallel Programming">DaCe</abbr> will warn about such situation while building the <abbr title="Stateful Dataflow multiGraphs (DaCe concept)">SDFG</abbr>, reporting a Memlet that reads undefined memory.</p>
</details>
<h3 id="expanding-the-library-nodes">Expanding the library nodes</h3>
<p>Expanding a library node results in what the <code>SDFGManager</code> knows as the <code>expanded_sdfg</code>. There's no caching at this level. All library nodes are - one by one - transformed by the <code>expansion()</code> call on <code>StencilComputationExpansion</code><sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup>. This forms one big <abbr title="Stateful Dataflow multiGraphs (DaCe concept)">SDFG</abbr> on which "post expansion transformations" (eliminating trivial maps, controlling OpenMP parallelization) are applied.</p>
<p>Library node expansion is again a two step process:</p>
<ol>
<li>Build <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR from OIR</li>
<li>Build a nested <abbr title="Stateful Dataflow multiGraphs (DaCe concept)">SDFG</abbr> from the <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR<ol>
<li>Codegen for code in Tasklets.</li>
</ol>
</li>
</ol>
<h4 id="building-dace-ir-from-oir">Building <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR from OIR</h4>
<p>The <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR is built in <code>DaCeIRBuilder</code><sup id="fnref:4"><a class="footnote-ref" href="#fn:4">4</a></sup>. <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR is a hybrid IR somewhere between keeping semantic information (e.g. <code>dcir.HorizontalRestriction</code>) used for potential optimizations and - on the other hand - trying to be close to the <abbr title="Stateful Dataflow multiGraphs (DaCe concept)">SDFG</abbr> (e.g. <code>dcir.Memlet</code> and <code>dcir.Tasklet</code>). This dual-use make the IR a bit cumbersome to work with at times. A task<sup id="fnref:5"><a class="footnote-ref" href="#fn:5">5</a></sup> was logged to evaluate splitting the IR.</p>
<details class="note">
<summary>First version and bridge refactors</summary>
<p>The original bridge was written in a way that pushed all code of a <code>oir.HorizontalRegion</code> into one big <code>Tasklet</code>, hiding all control flow happening inside horizontal regions. Control flow was exposed with <a href="https://github.com/GridTools/gt4py/pull/1894">this PR</a>. In many places, you might see remnants of that past and sub-optimal design decisions that we'll need to address in the future.</p>
</details>
<p>A rundown of what we do while building the IR</p>
<ol>
<li>The IR starts a the <code>oir.VerticalLoop</code> level, where the "unexpanded <abbr title="Stateful Dataflow multiGraphs (DaCe concept)">SDFG</abbr>" left off.</li>
<li>"Expansions" are the current system to change loop order depending on HW (currently: hard-coded lists for <abbr title="Central Processing Unit">CPU</abbr>- and <abbr title="Graphics Processing Unit">GPU</abbr>-devices)</li>
<li>While visiting <code>oir.HorizontalRegion</code>s, we recursively create <code>oir.CodeBlock</code>s, to group statements that belong together. Initially, the body the <code>oir.HorizontalRegion</code> is put in a <code>CodeBlock</code>. As we then process the <code>oir</code> statements in that <code>CodeBlock</code> and we recursively add nested <code>oir.CodeBlocks</code> to group the bodies of <code>oir.MaskStmt</code>s and <code>oir.While</code> loops. This allows us to keep track of <code>targets</code>, the set of variables written in the current <code>Tasklet</code>. <code>targets</code> are used when visiting <code>FieldAccess</code> or <code>ScalarAccess</code> to name the variables. For each Tasklet map incoming Memlets to <code>gtIN__{name}</code> and outgoing Memlets to <code>gtOUT__{name}</code>. We thus need to know if read from or write to a variable/field. Furthermore, when reading after writing to the same variable within a Tasklet, we need to read from the "out"-version of the variable that was previously written.</li>
<li>While loops and if statements inside horizontal regions are translated to <code>dcir.While</code> and <code>dcir.MaskStmt</code> which will generate control flow in tasklet code. A <a href="https://github.com/GridTools/gt4py/issues/1900">task</a> was logged to change this in the future. For now we keep it as-is because this would need changes to the <code>HorizontalMaskRemover</code>, which operates on the <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR mid-flight while building (see <code>remove_horizontal_region()</code> inside <code>_process_map_item()</code> in the <code>DaCeIRBuilder</code>).</li>
<li>Each <code>oir.CodeBlock</code> is then translated into one of three objects<ol>
<li><code>dcir.ComputeState</code> wraps assignment statements in a <code>dcir.Tasklet</code></li>
<li><code>dcir.Condition</code> contains a <code>dcir.Tasklet</code> to evaluate the condition and a <code>true_state</code> of type <code>ComputeState | Condition | WhileLoop</code>. Technically, the <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR also allows a <code>false_state</code>. However, somewhere in "higher IRs" the decision was made to transform all <code>else</code> branches to separate <code>if</code> statements with a negated condition.</li>
<li><code>dcir.WhileLoop</code> contains a <code>dcir.Tasklet</code> to evaluate the condition and a <code>body</code> of type <code>ComputeState | Condition | WhileLoop</code></li>
</ol>
</li>
<li>When a <code>dcir.Tasklet</code>s is built, we construct <code>dcir.Memlets</code> for field access inside that Tasklet from the oir. Memlets for scalar access are only added when building the <abbr title="Stateful Dataflow multiGraphs (DaCe concept)">SDFG</abbr> from the <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR (see below).</li>
<li>After a tasklet is built, <code>_fix_memlet_array_access()</code> runs a pass for Memlets with partial index subset, variable offset reads, or K-write offsets. This pass writes explicit indices into <code>explicit_indices</code>, which are then used during Tasklet codegen (see below). We should revisit this and clean up our approach to indexing (see note below).</li>
</ol>
<details class="note">
<summary>Refactor opportunity: <code>if</code> / <code>else</code> statements</summary>
<p>We should track down where <code>else</code> branches of <code>if</code> statements get "lost" and propagate them all the way down to <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR and when we build the SDFGs. While <abbr title="Data-Centric Parallel Programming">DaCe</abbr> has a pass that detects subsequent <code>if</code> statements with negated conditions, it doesn't always apply. As a result, our generated code is over complicated. We don't expect this to impact performance to the point that it matters now, but it might in the future and - more importantly - it makes debugging and reasoning about generated code more complicated than it has to be.</p>
</details>
<details class="note">
<summary>Refactor opportunity: Indexing</summary>
<p><code>_fix_memlet_array_access()</code> was introduced as a <a href="https://github.com/GridTools/gt4py/pull/1410">temporary fix</a> after <abbr title="Data-Centric Parallel Programming">DaCe</abbr> stopped support for partial index subset. We should re-visit indexing as a whole and find a cleaner solution that doesn't create partial index subsets in the first place and supports new features like variable offset reads and K-offset writes.</p>
</details>
<p><div class="mxgraph" data-mxgraph='{"toolbar": "zoom", "tooltips": "1", "border": 5, "resize": "1", "edit": "_blank", "highlight": null, "xml": "&lt;mxfile scale=\"1\" border=\"0\" host=\"app.diagrams.net\" agent=\"Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0\" version=\"26.1.0\"&gt;\n  &lt;diagram name=\"Seite-1\" id=\"uBIzncXjYzNze9gtcR0E\"&gt;\n    &lt;mxGraphModel dx=\"2586\" dy=\"1349\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"827\" pageHeight=\"1169\" math=\"0\" shadow=\"0\"&gt;\n      &lt;root&gt;\n        &lt;mxCell id=\"0\"/&gt;\n        &lt;mxCell id=\"1\" parent=\"0\"/&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-39\" value=\"\" style=\"shape=ext;double=1;rounded=0;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n          &lt;mxGeometry x=\"50\" y=\"750\" width=\"720\" height=\"250\" as=\"geometry\"/&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-35\" value=\"\" style=\"ellipse;shape=cloud;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n          &lt;mxGeometry x=\"619\" y=\"495\" width=\"176\" height=\"160\" as=\"geometry\"/&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-29\" value=\"\" style=\"ellipse;shape=cloud;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n          &lt;mxGeometry x=\"352\" y=\"115\" width=\"176\" height=\"160\" as=\"geometry\"/&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-1\" value=\"&amp;lt;div style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;statement0&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;statement1&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;br&amp;gt;&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;if condition:&amp;lt;br&amp;gt;&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;amp;nbsp; statement2&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;amp;nbsp; statement3&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;br&amp;gt;&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;amp;nbsp; while condition2:&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;amp;nbsp;&amp;amp;nbsp;&amp;amp;nbsp; statement4&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;amp;nbsp;&amp;amp;nbsp;&amp;amp;nbsp; statement5&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;br&amp;gt;&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;amp;nbsp; statement6&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;amp;nbsp; statement7&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;br&amp;gt;&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;statement8&amp;lt;/font&amp;gt;&amp;lt;font style=&amp;quot;font-size: 20px;&amp;quot;&amp;gt;&amp;lt;br&amp;gt;&amp;lt;/font&amp;gt;&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;\" style=\"whiteSpace=wrap;html=1;aspect=fixed;fontFamily=Courier Prime;fontSource=https%3A%2F%2Ffonts.googleapis.com%2Fcss%3Ffamily%3DCourier%2BPrime;align=left;verticalAlign=top;fillColor=#dae8fc;strokeColor=#6c8ebf;opacity=80;\" parent=\"1\" vertex=\"1\"&gt;\n          &lt;mxGeometry x=\"250\" y=\"331\" width=\"369\" height=\"369\" as=\"geometry\"/&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-5\" value=\"\" style=\"whiteSpace=wrap;html=1;aspect=fixed;fillColor=#d5e8d4;strokeColor=#82b366;opacity=50;\" parent=\"1\" vertex=\"1\"&gt;\n          &lt;mxGeometry x=\"270\" y=\"430\" width=\"230\" height=\"230\" as=\"geometry\"/&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-7\" value=\"\" style=\"rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;opacity=70;\" parent=\"1\" vertex=\"1\"&gt;\n          &lt;mxGeometry x=\"296\" y=\"525\" width=\"240\" height=\"65\" as=\"geometry\"/&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-13\" value=\"\" style=\"shape=crossbar;whiteSpace=wrap;html=1;rounded=1;direction=south;\" parent=\"1\" vertex=\"1\"&gt;\n          &lt;mxGeometry x=\"90\" y=\"331\" width=\"20\" height=\"369\" as=\"geometry\"/&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-16\" value=\"\" style=\"shape=crossbar;whiteSpace=wrap;html=1;rounded=1;direction=south;\" parent=\"1\" vertex=\"1\"&gt;\n          &lt;mxGeometry x=\"125\" y=\"410\" width=\"20\" height=\"250\" as=\"geometry\"/&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-17\" value=\"\" style=\"shape=crossbar;whiteSpace=wrap;html=1;rounded=1;direction=south;\" parent=\"1\" vertex=\"1\"&gt;\n          &lt;mxGeometry x=\"150\" y=\"517.5\" width=\"20\" height=\"80\" as=\"geometry\"/&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-19\" value=\"HorizontalExecution\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" parent=\"1\" vertex=\"1\"&gt;\n          &lt;mxGeometry x=\"140\" y=\"331\" width=\"60\" height=\"30\" as=\"geometry\"/&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-20\" value=\"&amp;lt;div&amp;gt;Condition&amp;lt;/div&amp;gt;\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" parent=\"1\" vertex=\"1\"&gt;\n          &lt;mxGeometry x=\"145\" y=\"410\" width=\"60\" height=\"30\" as=\"geometry\"/&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-23\" value=\"&amp;lt;div&amp;gt;Loop&amp;lt;/div&amp;gt;\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" parent=\"1\" vertex=\"1\"&gt;\n          &lt;mxGeometry x=\"170\" y=\"517.5\" width=\"60\" height=\"30\" as=\"geometry\"/&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-24\" value=\"&amp;lt;font style=&amp;quot;font-size: 24px;&amp;quot; data-font-src=&amp;quot;https://fonts.googleapis.com/css?family=Caveat&amp;quot; face=&amp;quot;Caveat&amp;quot;&amp;gt;statements are evaluated in a Tasklet&amp;lt;/font&amp;gt;\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" parent=\"1\" vertex=\"1\"&gt;\n          &lt;mxGeometry x=\"380\" y=\"130\" width=\"120\" height=\"130\" as=\"geometry\"/&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-28\" value=\"\" style=\"curved=1;endArrow=classic;html=1;rounded=0;\" parent=\"1\" source=\"k6TCTClMSMkHMvDiaAWe-29\" target=\"k6TCTClMSMkHMvDiaAWe-1\" edge=\"1\"&gt;\n          &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n            &lt;mxPoint x=\"310\" y=\"190\" as=\"sourcePoint\"/&gt;\n            &lt;mxPoint x=\"330\" y=\"180\" as=\"targetPoint\"/&gt;\n            &lt;Array as=\"points\"&gt;\n              &lt;mxPoint x=\"330\" y=\"230\"/&gt;\n              &lt;mxPoint x=\"270\" y=\"300\"/&gt;\n            &lt;/Array&gt;\n          &lt;/mxGeometry&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-31\" value=\"\" style=\"ellipse;shape=cloud;whiteSpace=wrap;html=1;\" parent=\"1\" vertex=\"1\"&gt;\n          &lt;mxGeometry x=\"540\" y=\"130\" width=\"230\" height=\"180\" as=\"geometry\"/&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-32\" value=\"&amp;lt;font data-font-src=&amp;quot;https://fonts.googleapis.com/css?family=Caveat&amp;quot; face=&amp;quot;Caveat&amp;quot; style=&amp;quot;font-size: 24px;&amp;quot;&amp;gt;nested code blocks in conditions and while loops&amp;lt;/font&amp;gt;\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" parent=\"1\" vertex=\"1\"&gt;\n          &lt;mxGeometry x=\"598\" y=\"155\" width=\"120\" height=\"130\" as=\"geometry\"/&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-33\" value=\"\" style=\"curved=1;endArrow=classic;html=1;rounded=0;exitX=0.55;exitY=0.95;exitDx=0;exitDy=0;exitPerimeter=0;entryX=0.488;entryY=0.241;entryDx=0;entryDy=0;entryPerimeter=0;\" parent=\"1\" source=\"k6TCTClMSMkHMvDiaAWe-31\" target=\"k6TCTClMSMkHMvDiaAWe-1\" edge=\"1\"&gt;\n          &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n            &lt;mxPoint x=\"680\" y=\"430\" as=\"sourcePoint\"/&gt;\n            &lt;mxPoint x=\"730\" y=\"380\" as=\"targetPoint\"/&gt;\n            &lt;Array as=\"points\"&gt;\n              &lt;mxPoint x=\"580\" y=\"370\"/&gt;\n              &lt;mxPoint x=\"440\" y=\"380\"/&gt;\n            &lt;/Array&gt;\n          &lt;/mxGeometry&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-34\" value=\"&amp;lt;font style=&amp;quot;font-size: 24px;&amp;quot; data-font-src=&amp;quot;https://fonts.googleapis.com/css?family=Caveat&amp;quot; face=&amp;quot;Caveat&amp;quot;&amp;gt;each color denotes one &amp;lt;/font&amp;gt;&amp;lt;font style=&amp;quot;font-size: 18px;&amp;quot; face=&amp;quot;Courier Prime&amp;quot; data-font-src=&amp;quot;https://fonts.googleapis.com/css?family=Courier+Prime&amp;quot;&amp;gt;CodeBlock&amp;lt;/font&amp;gt;&amp;lt;font style=&amp;quot;font-size: 24px;&amp;quot; data-font-src=&amp;quot;https://fonts.googleapis.com/css?family=Caveat&amp;quot; face=&amp;quot;Caveat&amp;quot;&amp;gt;&amp;lt;br&amp;gt;&amp;lt;/font&amp;gt;\" style=\"text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" parent=\"1\" vertex=\"1\"&gt;\n          &lt;mxGeometry x=\"650\" y=\"510\" width=\"120\" height=\"130\" as=\"geometry\"/&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\"k6TCTClMSMkHMvDiaAWe-36\" value=\"&amp;lt;div align=&amp;quot;left&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 14px; background-color: transparent;&amp;quot; data-font-src=&amp;quot;https://fonts.googleapis.com/css?family=Courier+Prime&amp;quot; face=&amp;quot;Courier Prime&amp;quot;&amp;gt;oir.CodeBlock&amp;lt;/font&amp;gt;&amp;lt;span style=&amp;quot;font-size: 14px; background-color: transparent;&amp;quot;&amp;gt; allows to use visitor pattern in daceir_builder. unused in other backends&amp;lt;/span&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div align=&amp;quot;left&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 14px;&amp;quot;&amp;gt;&amp;lt;font data-font-src=&amp;quot;https://fonts.googleapis.com/css?family=Courier+Prime&amp;quot; face=&amp;quot;Courier Prime&amp;quot;&amp;gt;dcir.Condition&amp;lt;/font&amp;gt; state transitions for conditions (the body is a CodeBlock)&amp;lt;br&amp;gt;&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div align=&amp;quot;left&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 14px;&amp;quot;&amp;gt;&amp;lt;font data-font-src=&amp;quot;https://fonts.googleapis.com/css?family=Courier+Prime&amp;quot; face=&amp;quot;Courier Prime&amp;quot;&amp;gt;dcir.WhileLoop&amp;lt;/font&amp;gt; state transitions for while loops (the body is a CodeBlock)&amp;lt;br&amp;gt;&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div align=&amp;quot;left&amp;quot;&amp;gt;&amp;lt;font style=&amp;quot;font-size: 14px;&amp;quot;&amp;gt;&amp;lt;br&amp;gt;&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div&amp;gt;&amp;lt;font style=&amp;quot;font-size: 14px;&amp;quot;&amp;gt;&amp;lt;br&amp;gt;&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div&amp;gt;&amp;lt;font size=&amp;quot;3&amp;quot;&amp;gt;visit_CodeBlock(node: oir.CodeBlock, ...):&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div&amp;gt;&amp;lt;font size=&amp;quot;3&amp;quot;&amp;gt;&amp;amp;nbsp; - separates statements from potential nested CodeBlocks&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div&amp;gt;&amp;lt;font size=&amp;quot;3&amp;quot;&amp;gt;&amp;amp;nbsp; - visit statements and potential nested CodeBlocks&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div&amp;gt;&amp;lt;font size=&amp;quot;3&amp;quot;&amp;gt;&amp;amp;nbsp; - wires output from statements to nested CodeBlocks&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div&amp;gt;&amp;lt;font size=&amp;quot;3&amp;quot;&amp;gt;&amp;amp;nbsp; - wires output form nested CodeBlocks to statements at the end of the CodeBlock&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div&amp;gt;&amp;lt;font size=&amp;quot;3&amp;quot;&amp;gt;&amp;lt;br&amp;gt;&amp;lt;/font&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div&amp;gt;&amp;lt;br&amp;gt;&amp;lt;/div&amp;gt;\" style=\"text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;\" parent=\"1\" vertex=\"1\"&gt;\n          &lt;mxGeometry x=\"80\" y=\"760\" width=\"680\" height=\"260\" as=\"geometry\"/&gt;\n        &lt;/mxCell&gt;\n      &lt;/root&gt;\n    &lt;/mxGraphModel&gt;\n  &lt;/diagram&gt;\n&lt;/mxfile&gt;"}' style="max-width:100%;border:1px solid transparent;"></div></p>
<details class="note">
<summary>Refactor opportunity: <code>CodeBlock</code>s</summary>
<p><code>CodeBlock</code>s were added at the OIR-level such that the <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR visitor could recursively create and visit them at the same time. <code>oir.CodeBlock</code>s are not used in any other backend for now. This is fundamentally not the way to how build things nicely and a temporary duct tape solution. We should propagate <code>gtir.BlockStmt</code> throughout the <code>oir</code>-level and re-use that instead in the <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR. <code>if</code> / <code>else</code> statements should be kept together at the <code>oir</code>-level. <code>oir.MaskStmt</code> sounds like we were catering too much for the <code>numpy</code> backend in the past.</p>
</details>
<h4 id="building-sdfg-from-dace-ir">Building <abbr title="Stateful Dataflow multiGraphs (DaCe concept)">SDFG</abbr> from <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR</h4>
<p>The main work is done in <code>StencilComputationSDFGBuilder</code><sup id="fnref:6"><a class="footnote-ref" href="#fn:6">6</a></sup>. Tasklet code is generated in a separate visitor, <code>TaskletCodegen</code><sup id="fnref:7"><a class="footnote-ref" href="#fn:7">7</a></sup>.</p>
<p><code>StencilComputationSDFGBuilder</code> is your standard node visitor translating the <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-related concepts of <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR to actual SDFGs. Whenever this process is not straight forward, it's because we didn't prepare things well enough in previous steps. One notable pain point is how we access scalar variables. In the image above, note how <code>statements{0,1,8}</code> are in the same (blue) <code>CodeBlock</code>. In the <abbr title="Stateful Dataflow multiGraphs (DaCe concept)">SDFG</abbr> representation, the picture looks more like this</p>
<p><div class="mxgraph" data-mxgraph='{"toolbar": "zoom", "tooltips": "1", "border": 5, "resize": "1", "edit": "_blank", "highlight": null, "xml": "&lt;mxfile host=\"65bd71144e\"&gt;\n    &lt;diagram id=\"eNCR_hebGBwhbkEAAWyX\" name=\"Page-1\"&gt;\n        &lt;mxGraphModel dx=\"1890\" dy=\"1151\" grid=\"1\" gridSize=\"10\" guides=\"1\" tooltips=\"1\" connect=\"1\" arrows=\"1\" fold=\"1\" page=\"1\" pageScale=\"1\" pageWidth=\"850\" pageHeight=\"1100\" math=\"0\" shadow=\"0\"&gt;\n            &lt;root&gt;\n                &lt;mxCell id=\"0\"/&gt;\n                &lt;mxCell id=\"1\" parent=\"0\"/&gt;\n                &lt;mxCell id=\"8\" value=\"\" style=\"rounded=0;whiteSpace=wrap;html=1;strokeWidth=2;fillWeight=4;hachureGap=8;hachureAngle=45;fillColor=#dae8fc;strokeColor=#6c8ebf;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"160\" y=\"80\" width=\"240\" height=\"120\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"2\" value=\"statement0&amp;lt;br&amp;gt;statement1\" style=\"whiteSpace=wrap;html=1;shape=mxgraph.basic.octagon2;align=center;verticalAlign=middle;dx=15;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"205\" y=\"115\" width=\"150\" height=\"50\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"16\" value=\"guard state\" style=\"rounded=0;whiteSpace=wrap;html=1;strokeWidth=2;fillWeight=4;hachureGap=8;hachureAngle=45;fillColor=#dae8fc;strokeColor=#6c8ebf;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"200\" y=\"400\" width=\"160\" height=\"40\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"17\" value=\"merge state\" style=\"rounded=0;whiteSpace=wrap;html=1;strokeWidth=2;fillWeight=4;hachureGap=8;hachureAngle=45;fillColor=#dae8fc;strokeColor=#6c8ebf;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"200\" y=\"880\" width=\"160\" height=\"40\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"19\" value=\"eval if condition\" style=\"whiteSpace=wrap;html=1;shape=mxgraph.basic.octagon2;align=center;verticalAlign=middle;dx=15;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"205\" y=\"275\" width=\"150\" height=\"50\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"20\" value=\"\" style=\"rounded=0;whiteSpace=wrap;html=1;strokeWidth=2;fillWeight=4;hachureGap=8;hachureAngle=45;fillColor=#dae8fc;strokeColor=#6c8ebf;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"280\" y=\"480\" width=\"240\" height=\"120\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"21\" value=\"statement2&amp;lt;div&amp;gt;statement3&amp;lt;/div&amp;gt;\" style=\"whiteSpace=wrap;html=1;shape=mxgraph.basic.octagon2;align=center;verticalAlign=middle;dx=15;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"325\" y=\"515\" width=\"150\" height=\"50\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"22\" value=\"\" style=\"rounded=0;whiteSpace=wrap;html=1;strokeWidth=2;fillWeight=4;hachureGap=8;hachureAngle=45;fillColor=#dae8fc;strokeColor=#6c8ebf;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"160\" y=\"240\" width=\"240\" height=\"120\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"23\" value=\"eval if condition\" style=\"whiteSpace=wrap;html=1;shape=mxgraph.basic.octagon2;align=center;verticalAlign=middle;dx=15;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"205\" y=\"275\" width=\"150\" height=\"50\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"31\" value=\"\" style=\"rounded=0;whiteSpace=wrap;html=1;strokeWidth=2;fillWeight=4;hachureGap=8;hachureAngle=45;fillColor=#dae8fc;strokeColor=#6c8ebf;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"280\" y=\"720\" width=\"240\" height=\"120\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"32\" value=\"statement6&amp;lt;div&amp;gt;statement7&amp;lt;/div&amp;gt;\" style=\"whiteSpace=wrap;html=1;shape=mxgraph.basic.octagon2;align=center;verticalAlign=middle;dx=15;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"325\" y=\"755\" width=\"150\" height=\"50\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"33\" value=\"\" style=\"rounded=0;whiteSpace=wrap;html=1;strokeWidth=2;fillWeight=4;hachureGap=8;hachureAngle=45;fillColor=#dae8fc;strokeColor=#6c8ebf;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"160\" y=\"960\" width=\"240\" height=\"120\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"34\" value=\"statement8\" style=\"whiteSpace=wrap;html=1;shape=mxgraph.basic.octagon2;align=center;verticalAlign=middle;dx=15;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"205\" y=\"995\" width=\"150\" height=\"50\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"35\" value=\"while loop\" style=\"shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;\" vertex=\"1\" parent=\"1\"&gt;\n                    &lt;mxGeometry x=\"320\" y=\"640\" width=\"160\" height=\"40\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"42\" value=\"\" style=\"endArrow=classic;html=1;entryX=0.25;entryY=0;entryDx=0;entryDy=0;exitX=0.25;exitY=1;exitDx=0;exitDy=0;\" edge=\"1\" parent=\"1\" source=\"16\" target=\"17\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"150\" y=\"470\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"190\" y=\"530\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"43\" value=\"False\" style=\"edgeLabel;resizable=0;html=1;;align=center;verticalAlign=middle;\" connectable=\"0\" vertex=\"1\" parent=\"42\"&gt;\n                    &lt;mxGeometry relative=\"1\" as=\"geometry\"/&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"44\" value=\"\" style=\"edgeStyle=segmentEdgeStyle;endArrow=classic;html=1;curved=0;rounded=0;endSize=8;startSize=8;entryX=0.5;entryY=0;entryDx=0;entryDy=0;\" edge=\"1\" parent=\"1\" target=\"20\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"360\" y=\"420\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"410\" y=\"370\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"45\" value=\"True\" style=\"edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];\" vertex=\"1\" connectable=\"0\" parent=\"44\"&gt;\n                    &lt;mxGeometry x=\"0.004\" y=\"4\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"-4\" y=\"10\" as=\"offset\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"46\" value=\"\" style=\"endArrow=classic;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;\" edge=\"1\" parent=\"1\" target=\"22\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"280\" y=\"200\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"330\" y=\"150\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"47\" value=\"\" style=\"endArrow=classic;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;\" edge=\"1\" parent=\"1\" target=\"16\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"280\" y=\"360\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"330\" y=\"310\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"48\" value=\"\" style=\"endArrow=classic;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;entryPerimeter=0;\" edge=\"1\" parent=\"1\" target=\"35\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"400\" y=\"600\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"450\" y=\"550\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"49\" value=\"\" style=\"endArrow=classic;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;exitPerimeter=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;\" edge=\"1\" parent=\"1\" source=\"35\" target=\"31\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"410\" y=\"690\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"460\" y=\"640\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"50\" value=\"\" style=\"edgeStyle=segmentEdgeStyle;endArrow=classic;html=1;curved=0;rounded=0;endSize=8;startSize=8;entryX=1;entryY=0.5;entryDx=0;entryDy=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;\" edge=\"1\" parent=\"1\" source=\"31\" target=\"17\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"445\" y=\"870\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"405\" y=\"930\" as=\"targetPoint\"/&gt;\n                        &lt;Array as=\"points\"&gt;\n                            &lt;mxPoint x=\"400\" y=\"900\"/&gt;\n                        &lt;/Array&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n                &lt;mxCell id=\"51\" value=\"\" style=\"endArrow=classic;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;\" edge=\"1\" parent=\"1\" target=\"33\"&gt;\n                    &lt;mxGeometry width=\"50\" height=\"50\" relative=\"1\" as=\"geometry\"&gt;\n                        &lt;mxPoint x=\"280\" y=\"920\" as=\"sourcePoint\"/&gt;\n                        &lt;mxPoint x=\"330\" y=\"870\" as=\"targetPoint\"/&gt;\n                    &lt;/mxGeometry&gt;\n                &lt;/mxCell&gt;\n            &lt;/root&gt;\n        &lt;/mxGraphModel&gt;\n    &lt;/diagram&gt;\n&lt;/mxfile&gt;"}' style="max-width:100%;border:1px solid transparent;"></div></p>
<p>Notice how <code>statements{0,1}</code> are in one Tasklet and <code>statement8</code> is in another Tasklet. If any local temporaries are written as part of statements 0 or 1, they could be read in <code>statement8</code>. We thus don't have any local scalars anymore and expose all writes (to scalars) for possible future reads. A standard <abbr title="Data-Centric Parallel Programming">DaCe</abbr> cleanup pass will get rid of any unused write access node. This only needs special care for local scalar accesses because array memory is managed at the (nested) <abbr title="Stateful Dataflow multiGraphs (DaCe concept)">SDFG</abbr> level. In the first version of the bridge, scalars could be represented as local scalars of the one big Tasklet. This leave a refactor opportunity to adapt the <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR.</p>
<details class="note">
<summary>Refactor opportunity: Memlets for scalar accesses</summary>
<p>In the first version of the bridges, scalar could be treated as local scalars of the one big Tasklet that existed. There was thus no need for scalar access to be represented in Memlets. When re-designing the <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR and/or when looking at Indexing, we should take a moment to asses what we could do better in terms of how we handle scalars. We should aim for knowing if a scalar is going to be read in a subsequent Tasklet when we build the <abbr title="Stateful Dataflow multiGraphs (DaCe concept)">SDFG</abbr>.</p>
</details>
<details class="note">
<summary>Refactor opportunity: Memlets and <code>node_ctx</code></summary>
<p>The <code>StencilComputationSDFGBuilder</code> holds a "node context" to keep track of Memlets and where to connect them to/from. When re-designing the <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR, we should aim for getting that information into the last IR before building SDFGs such that we can just focus on building the <abbr title="Stateful Dataflow multiGraphs (DaCe concept)">SDFG</abbr> at this point.</p>
</details>
<h4 id="code-generation-for-tasklets">Code generation for Tasklets</h4>
<p>Tasklet code is generated in <code>TaskletCodegen</code>, which is called from <code>StencilComputationSDFGBuilder</code> when visiting Tasklets. It translates <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR statements back into python code and - more importantly - handles Memlets going into and out of the Tasklet.</p>
<details class="note">
<summary>Refactor opportunity: Indexing (part two)</summary>
<p>The indexing hacks done when building the <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-IR show here again because we now need to handle special cases, e.g for explicit vs. non-explicit indexing.</p>
</details>
<details class="note">
<summary>Refactor opportunity: Horizontal regions in Tasklets</summary>
<p>Even after exposing control flow with <a href="https://github.com/GridTools/gt4py/pull/1894">this PR</a>, some Tasklets still contain code flow. This comes from two sources: ternary operators (we don't care too much about that for now) and horizontal regions. In the future, we should aim for getting all horizontal regions out of Tasklet code.</p>
</details>
<h2 id="orchestration">Orchestration</h2>
<p><abbr title="NOAA/NASA Domain Specific Language middleware">NDSL</abbr> supercharges <abbr title="Data-Centric Parallel Programming">DaCe</abbr>-backends by not only "daceifying" <abbr title="GridTools for Python">GT4Py</abbr> stencils but also the code in between. This results in one big <abbr title="Stateful Dataflow multiGraphs (DaCe concept)">SDFG</abbr> that can be analyzed with the powers of <abbr title="Data-Centric Parallel Programming">DaCe</abbr>.</p>
<h2 id="future-work">Future work</h2>
<p>Future work includes leveraging <abbr title="Data-Centric Parallel Programming">DaCe</abbr>'s schedule tree to adapt the loop order and merge loops along the same axis (possibly with over-computation).</p>
<p>We'd also like to look into HW-dependant scheduling and JIT tiling.</p>
<!-- institutions / groups / teams -->
<!-- technology -->
<!-- GEOS Fortran names -->
<!-- other -->
<div class="footnote">
<hr/>
<ol>
<li id="fn:1">
<p><a href="https://github.com/GridTools/gt4py/blob/main/src/gt4py/cartesian/gtc/dace/oir_to_dace.py">https://github.com/GridTools/gt4py/blob/main/src/gt4py/cartesian/gtc/dace/oir_to_dace.py</a> <a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn:2">
<p><a href="https://github.com/GridTools/gt4py/blob/main/src/gt4py/cartesian/backend/dace_backend.py">https://github.com/GridTools/gt4py/blob/main/src/gt4py/cartesian/backend/dace_backend.py</a> <a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn:3">
<p><a href="https://github.com/GridTools/gt4py/blob/main/src/gt4py/cartesian/gtc/dace/expansion/expansion.py">https://github.com/GridTools/gt4py/blob/main/src/gt4py/cartesian/gtc/dace/expansion/expansion.py</a> <a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
<li id="fn:4">
<p><a href="https://github.com/GridTools/gt4py/blob/main/src/gt4py/cartesian/gtc/dace/expansion/daceir_builder.py">https://github.com/GridTools/gt4py/blob/main/src/gt4py/cartesian/gtc/dace/expansion/daceir_builder.py</a> <a class="footnote-backref" href="#fnref:4" title="Jump back to footnote 4 in the text">↩</a></p>
</li>
<li id="fn:5">
<p><a href="https://github.com/GridTools/gt4py/issues/1898">https://github.com/GridTools/gt4py/issues/1898</a> <a class="footnote-backref" href="#fnref:5" title="Jump back to footnote 5 in the text">↩</a></p>
</li>
<li id="fn:6">
<p><a href="https://github.com/GridTools/gt4py/blob/main/src/gt4py/cartesian/gtc/dace/expansion/sdfg_builder.py">https://github.com/GridTools/gt4py/blob/main/src/gt4py/cartesian/gtc/dace/expansion/sdfg_builder.py</a> <a class="footnote-backref" href="#fnref:6" title="Jump back to footnote 6 in the text">↩</a></p>
</li>
<li id="fn:7">
<p><a href="https://github.com/GridTools/gt4py/blob/main/src/gt4py/cartesian/gtc/dace/expansion/tasklet_codegen.py">https://github.com/GridTools/gt4py/blob/main/src/gt4py/cartesian/gtc/dace/expansion/tasklet_codegen.py</a> <a class="footnote-backref" href="#fnref:7" title="Jump back to footnote 7 in the text">↩</a></p>
</li>
</ol>
</div>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["search.suggest", "search.highlight", "search.share"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
<script src="https://viewer.diagrams.net/js/viewer-static.min.js"></script></body>
</html>